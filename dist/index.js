(()=>{var j=Object.create,P=Object.defineProperty,E=Object.getOwnPropertyDescriptor,O=Object.getOwnPropertyNames,F=Object.getPrototypeOf,V=Object.prototype.hasOwnProperty,_=(i,e)=>function(){return e||(0,i[O(i)[0]])((e={exports:{}}).exports,e),e.exports},N=(i,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of O(e))!V.call(i,r)&&r!==t&&P(i,r,{get:()=>e[r],enumerable:!(s=E(e,r))||s.enumerable});return i},T=(i,e,t)=>(t=i!=null?j(F(i)):{},N(e||!i||!i.__esModule?P(t,"default",{value:i,enumerable:!0}):t,i)),p=(i,e,t)=>new Promise((s,r)=>{var n=l=>{try{c(t.next(l))}catch(g){r(g)}},o=l=>{try{c(t.throw(l))}catch(g){r(g)}},c=l=>l.done?s(l.value):Promise.resolve(l.value).then(n,o);c((t=t.apply(i,e)).next())}),L=_({"node_modules/es5-ext/global.js"(i,e){var t=function(){if(typeof self=="object"&&self)return self;if(typeof window=="object"&&window)return window;throw new Error("Unable to resolve global `this`")};e.exports=function(){if(this)return this;if(typeof globalThis=="object"&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"__global__",{get:function(){return this},configurable:!0})}catch{return t()}try{return __global__||t()}finally{delete Object.prototype.__global__}}()}}),W=_({"node_modules/websocket/package.json"(i,e){e.exports={name:"websocket",description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",keywords:["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],author:"Brian McKelvey <theturtle32@gmail.com> (https://github.com/theturtle32)",contributors:["I\xF1aki Baz Castillo <ibc@aliax.net> (http://dev.sipdoc.net)"],version:"1.0.34",repository:{type:"git",url:"https://github.com/theturtle32/WebSocket-Node.git"},homepage:"https://github.com/theturtle32/WebSocket-Node",engines:{node:">=4.0.0"},dependencies:{bufferutil:"^4.0.1",debug:"^2.2.0","es5-ext":"^0.10.50","typedarray-to-buffer":"^3.1.5","utf-8-validate":"^5.0.2",yaeti:"^0.0.6"},devDependencies:{"buffer-equal":"^1.0.0",gulp:"^4.0.2","gulp-jshint":"^2.0.4","jshint-stylish":"^2.2.1",jshint:"^2.0.0",tape:"^4.9.1"},config:{verbose:!1},scripts:{test:"tape test/unit/*.js",gulp:"gulp"},main:"index",directories:{lib:"./lib"},browser:"lib/browser.js",license:"Apache-2.0"}}}),A=_({"node_modules/websocket/lib/version.js"(i,e){e.exports=W().version}}),C=_({"node_modules/websocket/lib/browser.js"(i,e){var t;if(typeof globalThis=="object")t=globalThis;else try{t=L()}catch{}finally{if(!t&&typeof window<"u"&&(t=window),!t)throw new Error("Could not determine global this")}var s=t.WebSocket||t.MozWebSocket,r=A();function n(o,c){var l;return c?l=new s(o,c):l=new s(o),l}s&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(o){Object.defineProperty(n,o,{get:function(){return s[o]}})}),e.exports={w3cwebsocket:s?n:null,version:r}}}),v=T(C(),1),D=class{constructor(i){this.ondisconnect=()=>{},this.onStateChange=e=>{},this.websocket=null,this.state="",this.address=i||void 0,this.latestIncomingData="",this.msgID=0,this.newData=()=>{},this.responseBuffer=[]}connect(i){return new Promise((e,t)=>{this.address===void 0&&(this.address=i||"ws://127.0.0.1:80"),this.websocket=new v.w3cwebsocket(this.address),this.websocket.onerror=s=>t(`Error connecting to BCI2000 at ${this.address}`),this.websocket.onclose=()=>{console.log("Connection closed"),this.ondisconnect()},this.websocket.onopen=()=>e(),this.websocket.onmessage=s=>{let{opcode:r,id:n,contents:o}=JSON.parse(s.data);switch(r){case"O":this.responseBuffer.push({id:n,response:o}),this.newData(o);break;default:break}}})}disconnect(){this.websocket.close()}connected(){return this.websocket!==null&&this.websocket.readyState===v.w3cwebsocket.OPEN}execute(i){return this.connected()?new Promise((e,t)=>{this.msgID=this.msgID+1,this.websocket.send(JSON.stringify({opcode:"E",id:this.msgID,contents:i})),this.newData=s=>e(s)}):Promise.reject("Cannot execute instruction: not connected to BCI2000")}getVersion(){return p(this,null,function*(){return(yield this.execute("Version")).split("\r")[0]})}showWindow(){return p(this,null,function*(){yield this.execute("Show Window")})}hideWindow(){return p(this,null,function*(){yield this.execute("Hide Window")})}startExecutable(i){return p(this,null,function*(){yield this.execute(`Start executable ${i}`)})}startDummyRun(){return p(this,null,function*(){yield this.startExecutable("SignalGenerator"),yield this.startExecutable("DummySignalProcessing"),yield this.startExecutable("DummyApplication")})}setWatch(i,e,t){return p(this,null,function*(){yield this.execute("Add watch "+i+" at "+e+":"+t)})}resetSystem(){return p(this,null,function*(){yield this.execute("Reset System")})}setConfig(){return p(this,null,function*(){yield this.execute("Set Config")})}start(){return p(this,null,function*(){yield this.execute("Start")})}stop(){return p(this,null,function*(){yield this.execute("Stop")})}kill(){return p(this,null,function*(){yield this.execute("Exit")})}stateListen(){setInterval(()=>p(this,null,function*(){let i=yield this.execute("GET SYSTEM STATE");i.trim()!=this.state&&this.onStateChange(i.trim())}),1e3)}getSubjectName(){return p(this,null,function*(){return yield this.execute("Get Parameter SubjectName")})}getTaskName(){return p(this,null,function*(){return yield this.execute("Get Parameter DataFile")})}setParameter(i){return p(this,null,function*(){yield this.execute(`Set paramater ${i}`)})}setState(i){return p(this,null,function*(){yield this.execute(`Set state ${i}`)})}getParameters(){return p(this,null,function*(){let e=(yield this.execute("List Parameters")).split(`
`),t={},s;return e.forEach(r=>{let n=r.split("=")[0],o=n.split(" ")[1],c=n.split(" ")[2],l=n.split(" ")[0].split(":");l.forEach((g,u)=>{switch(u){case 0:{t[l[0]]==null&&(t[l[0]]={}),s=t[l[0]];break}case 1:{t[l[0]][l[1]]==null&&(t[l[0]][l[1]]={}),s=t[l[0]][l[1]];break}case 2:{t[l[0]][l[1]][l[2]]==null&&(t[l[0]][l[1]][l[2]]={}),s=t[l[0]][l[1]][l[2]];break}default:}}),o!="matrix"?r.split("=")[1].split("//")[0].trim().split(" ").length==4?s[c]={dataType:o,value:{value:r.split("=")[1].split("//")[0].trim().split(" ")[0],defaultValue:r.split("=")[1].split("//")[0].trim().split(" ")[1],low:r.split("=")[1].split("//")[0].trim().split(" ")[2],high:r.split("=")[1].split("//")[0].trim().split(" ")[3]},comment:r.split("=")[1].split("//")[1]}:s[c]={dataType:o,value:r.split("=")[1].split("//")[0].trim(),comment:r.split("=")[1].split("//")[1]}:s[c]={dataType:o,value:r.split("=")[1].split("//")[0].trim(),comment:r.split("=")[1].split("//")[1]}}),t})}},x=T(C(),1),I=class{constructor(i){this._socket=null,this.onconnect=()=>{},this.onGenericSignal=e=>{},this.onStateVector=e=>{},this.onSignalProperties=e=>{},this.onStateFormat=e=>{},this.ondisconnect=()=>{},this.onReceiveBlock=()=>{},this.callingFrom="",this.states={},this.signal=null,this.signalProperties=null,this.stateFormat=null,this.stateVecOrder=null,this.SignalType={INT16:0,FLOAT24:1,FLOAT32:2,INT32:3},this.address=i}getNullTermString(i){var e="";let t=0;for(;t<i.byteLength;){var s=i.getUint8(t);if(t++,s==0)break;e+=String.fromCharCode(s)}return e}connect(i,e){let t=this;return t.address===void 0&&(t.address=i),this.callingFrom=e,new Promise((s,r)=>{t._socket=new x.w3cwebsocket(t.address),t._socket.binaryType="arraybuffer",t._socket.onerror=()=>{r("Error connecting to data source at "+t.address)},t._socket.onopen=()=>{t.onconnect(),s()},t._socket.onclose=()=>{t.ondisconnect(),setTimeout(()=>{console.log("Disconnected"),this.connect("")},1e3)},t._socket.onmessage=n=>{t._decodeMessage(n.data)}})}connected(){return this._socket!=null&&this._socket.readyState===x.w3cwebsocket.OPEN}_decodeMessage(i){let e=new DataView(i,0,1).getUint8(0);switch(e){case 3:let t=new DataView(i,1,i.byteLength-1);this._decodeStateFormat(t);break;case 4:let s=new DataView(i,1,2).getUint8(0);switch(s){case 1:let n=new DataView(i,2,i.byteLength-2);this._decodeGenericSignal(n);break;case 3:let o=new DataView(i,2,i.byteLength-2);this._decodeSignalProperties(o);break;default:console.error("Unsupported Supplement: "+s.toString());break}this.onReceiveBlock();break;case 5:let r=new DataView(i,1,i.byteLength-1);this._decodeStateVector(r);break;default:console.error("Unsupported Descriptor: "+e.toString());break}}_decodePhysicalUnits(i){let e;e={};let t=i.split(" "),s=0;return e.offset=Number(t[s++]),e.gain=Number(t[s++]),e.symbol=t[s++],e.vmin=Number(t[s++]),e.vmax=Number(t[s++]),e}_decodeSignalProperties(i){let e=this.getNullTermString(i);e=e.replace(/{/g," { "),e=e.replace(/}/g," } "),this.signalProperties={};let t=e.split(" "),s=[];for(let n=0;n<t.length;n++)t[n].trim()!==""&&s.push(t[n]);let r=0;if(this.signalProperties.name=s[r++],this.signalProperties.channels=[],s[r]==="{"){for(;s[++r]!=="}";)this.signalProperties.channels.push(s[r]);r++}else{let n=parseInt(s[r++]);for(let o=0;o<n;o++)this.signalProperties.channels.push((o+1).toString())}if(this.signalProperties.elements=[],s[r]==="{"){for(;s[++r]!=="}";)this.signalProperties.elements.push(s[r]);r++}else{let n=parseInt(s[r++]);for(let o=0;o<n;o++)this.signalProperties.elements.push((o+1).toString())}this.signalProperties.numelements=this.signalProperties.elements.length,this.signalProperties.signaltype=s[r++],this.signalProperties.channelunit=this._decodePhysicalUnits(s.slice(r,r+=5).join(" ")),this.signalProperties.elementunit=this._decodePhysicalUnits(s.slice(r,r+=5).join(" ")),r++,this.signalProperties.valueunits=[];for(let n=0;n<this.signalProperties.channels.length;n++)this.signalProperties.valueunits.push(this._decodePhysicalUnits(s.slice(r,r+=5).join(" ")));r++,this.onSignalProperties(this.signalProperties)}_decodeStateFormat(i){this.stateFormat={};let t=this.getNullTermString(i).split(`
`);for(let r=0;r<t.length;r++){if(t[r].trim().length===0)continue;let n=t[r].split(" "),o=n[0];this.stateFormat[o]={},this.stateFormat[o].bitWidth=parseInt(n[1]),this.stateFormat[o].defaultValue=parseInt(n[2]),this.stateFormat[o].byteLocation=parseInt(n[3]),this.stateFormat[o].bitLocation=parseInt(n[4])}let s=[];for(let r in this.stateFormat){let n=this.stateFormat[r].byteLocation*8;n+=this.stateFormat[r].bitLocation,s.push([r,n])}s.sort((r,n)=>r[1]<n[1]?-1:r[1]>n[1]?1:0),this.stateVecOrder=[];for(let r=0;r<s.length;r++){let n=s[r][0];this.stateVecOrder.push([n,this.stateFormat[n].bitWidth])}this.onStateFormat(this.stateFormat)}_decodeGenericSignal(i){let e=0,t=i.getUint8(e);e=e+1;let s=i.getUint16(e,!0);e=e+2;let r=i.getUint16(e,!0);e=e+2,e=e+i.byteOffset;let n=new DataView(i.buffer,e),o=[];for(let c=0;c<s;++c){o.push([]);for(let l=0;l<r;++l)switch(t){case this.SignalType.INT16:o[c].push(n.getInt16((r*c+l)*2,!0));break;case this.SignalType.FLOAT32:o[c].push(n.getFloat32((r*c+l)*4,!0));break;case this.SignalType.INT32:o[c].push(n.getInt32((r*c+l)*4,!0));break;case this.SignalType.FLOAT24:o[c].push(0);break;default:break}}this.signal=o,this.onGenericSignal(o)}_decodeStateVector(i){if(this.stateVecOrder==null)return;let e=new Int8Array(i.buffer),t=e.indexOf(0),s=e.indexOf(0,t+1),r=new TextDecoder,n=parseInt(r.decode(e.slice(1,t))),o=parseInt(r.decode(e.slice(t+1,s))),c=s+1,l=new DataView(i.buffer,c),g={};for(let u in this.stateFormat)g[u]=Array(o).fill(this.stateFormat[u].defaultValue);for(let u=0;u<o;u++){let d=new Uint8Array(l.buffer,l.byteOffset+u*n,n),h=[];for(let a=0;a<d.length;a++)h.push((d[a]&1)!==0?1:0),h.push((d[a]&2)!==0?1:0),h.push((d[a]&4)!==0?1:0),h.push((d[a]&8)!==0?1:0),h.push((d[a]&16)!==0?1:0),h.push((d[a]&32)!==0?1:0),h.push((d[a]&64)!==0?1:0),h.push((d[a]&128)!==0?1:0);for(let a=0;a<this.stateVecOrder.length;a++){let f=this.stateFormat[this.stateVecOrder[a][0]],m=f.byteLocation*8+f.bitLocation,S=0,w=1;for(let k=0;k<f.bitWidth;k++)h[m+k]&&(S=(S|w)>>>0),w=w<<1>>>0;g[this.stateVecOrder[a][0]][u]=S}}this.onStateVector(g),this.states=g}};var y=new D,b=new I,U=(i=0)=>new Promise(e=>setTimeout(e,i)),G=document.getElementById("connect"),$=document.querySelector("select");G.onclick=async()=>{let i=`ws://${$.value}`,e=document.createElement("p");e.innerText="Trying to connect...",document.body.appendChild(e);let t={};try{let s="";s+="Startup System localhost; ",s+="Add State StimulusCode 4 0; ",s+="Add State BrainClick 1 0; ",s+="Add State Baseline 1 0; ",s+="Add State TrialStart 1 0; ",s+="Start executable SignalGenerator; ",s+="Start executable DummyApplication; ",s+="Start executable DummySignalProcessing; ",s+="Set Parameter WSSourceServer *:20100; ",s+="Wait for connected; ",s+="Set Config; ",s+="Start; ";let r={},n=null,o=await y.connect(`${i}:80`).then(()=>!0).catch(u=>e.innerText=u),c=await y.execute("GET SYSTEM STATE");if(console.log(`BCI2000 Status: ${c}`),y.resetSystem(),!o||(console.log("Connected to Operator layer through NodeJS server"),y.execute(s),await U(4e3),!await b.connect(`${i}:20100`).then(()=>!0).catch(u=>e.innerText=u)))return;let g=await y.getVersion();e.innerText="Connected!",b.onGenericSignal=u=>{Object.keys(r).forEach(h=>{if(b.states[h]!=null){let a=b.states[h][0];console.log("Latest State",h,a)}}),n&&u.forEach((h,a)=>{t[a]||(t[a]=document.createElement("p"),document.body.appendChild(t[a])),t[a].innerHTML=`<b>${n.channels[a]}:</b> ${h.join(", ")}`})},b.onStateFormat=u=>{let d=["Recording","Running","SourceTime","StimulusTime","__pad0","TrialStart","Baseline"],h=Object.keys(u);h=h.filter(a=>!d.includes(a)),h.forEach(a=>{let f=Math.pow(u[a].bitWidth,2),m="";r[a]=Array.from({length:f},(S,w)=>(f>1?m=`${a}_${w}`:m=a,{data:!1,meta:{id:m}}))})},b.onSignalProperties=u=>{console.log("signalProperties",u),n=u}}catch(s){e.innerText=s}};})();
